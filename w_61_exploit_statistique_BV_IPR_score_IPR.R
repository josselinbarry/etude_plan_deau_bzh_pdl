# VERSION FINALISEE AU 202401
## En cours de création

# Analyse statistique des indicateurs PE et qualités d'eau ----

## Library ----
library(MASS)
library(stats)
library(tidyverse)
library(PerformanceAnalytics)


## Chargement des données ----

load(file = "data_processed/w_pe_bv_ipr_stat_vf_tot.Rdata")

## Test de correlation ----

correlations_toutes_variables_synth <- 
  chart.Correlation(stat_corr_bv_ipr %>% 
                      dplyr::select(surface_ipr,
                             surface_moy_pe_perm,
                             prct_surf_pehm_tdbv,
                             prct_synth, 
                             densite_synth,
                             intercept_synth,
                             densite_zhp_zhp_synth,
                             densite_connect_synth,
#                             qa,
#                             q5,
                             q5_qa,
#                             prop_marais,
#                             prop_zhp,
#                             prop_tdbv,
#                             taux_drain,
                             ipr, 
                             nel, 
                             ner),
                    histogram = TRUE,
                    pch = 19)

## modélisation de l'IPR en fonction des variables pressions plans d'eau ---

names(stat_corr_bv_ipr)

stat_corr_bv_ipr <- stat_corr_bv_ipr %>% 
  column_to_rownames("sta_id")

mod1_ner <- lm(ner ~
#             surface_ipr +
             surface_moy_pe_perm +
             prct_surf_pehm_tdbv +
             prct_synth +
             densite_synth +
             intercept_synth +
             densite_zhp_zhp_synth +
             densite_connect_synth +
#             qa +
#             q5 +
             q5_qa +
#             prop_marais +
#             prop_zhp +
#             prop_tdbv +
             taux_drain,
           data = stat_corr_bv_ipr)

mod1_ipr <- lm(ipr ~
             #             surface_ipr +
             surface_moy_pe_perm +
             prct_surf_pehm_tdbv +
             prct_synth +
             densite_synth +
             intercept_synth +
             densite_zhp_zhp_synth +
             densite_connect_synth +
             #             qa +
             #             q5 +
             q5_qa +
             #             prop_marais +
             #             prop_zhp +
             #             prop_tdbv +
             taux_drain,
           data = stat_corr_bv_ipr)



summary(mod1_ipr)

plot(mod1_ipr)

summary(mod1_ner)

plot(mod1_ner)

cook <- cooks.distance(mod1_ipr)

dist_cook <- as.data.frame(cook) %>% 
  rownames_to_column("sta_id") 

sf::write_sf(obj = dist_cook, dsn = "data/outputs/distance_cook_20240605.gpkg")


mod2_ipr <- MASS::stepAIC(mod1_ipr)

summary(mod2_ipr)

mod2_ner <- MASS::stepAIC(mod1_ner)

summary(mod2_ner)
  
# Sauvegarde

save(mod1_ipr,
     mod2_ipr,
     mod1_ner,
     mod2_ner,
     file = "data_processed/w_pe_bv_ipr_stat_vf_tot2.RData")


## Chargement des données LIM ----

load(file = "data_processed/w_pe_bv_ipr_stat_vf_lim.Rdata")

## Test de correlation ----

lim_correlations_toutes_variables_synth <- 
  chart.Correlation(stat_corr_bv_ipr_lim %>% 
                      dplyr::select(surface_ipr,
                                    surface_moy_pe_perm,
                                    prct_surf_pehm_tdbv,
                                    prct_synth, 
                                    densite_synth,
                                    intercept_synth,
                                    densite_zhp_zhp_synth,
                                    densite_connect_synth,
                                    #                             qa,
                                    #                             q5,
                                    q5_qa,
                                    #                             prop_marais,
                                    #                             prop_zhp,
                                    #                             prop_tdbv,
                                    #                             taux_drain,
                                    ipr, 
                                    nel, 
                                    ner),
                    histogram = TRUE,
                    pch = 19)

## modélisation de l'IPR en fonction des variables pressions plans d'eau ---

names(stat_corr_bv_ipr_lim)

stat_corr_bv_ipr_lim <- stat_corr_bv_ipr_lim %>% 
  column_to_rownames("sta_id")

mod1_lim_ipr <- lm(ipr ~
             #             surface_ipr +
                          surface_moy_pe_perm +
                          prct_surf_pehm_tdbv +
                          prct_synth +
             densite_synth +
                          intercept_synth +
                          densite_zhp_zhp_synth +
                          densite_connect_synth +
             #             qa +
             #             q5 +
             q5_qa +
             #             prop_marais +
             #             prop_zhp +
             #             prop_tdbv +
             taux_drain,
           data = stat_corr_bv_ipr_lim)

mod1_lim_ner <- lm(ner ~
                 #             surface_ipr +
                 surface_moy_pe_perm +
                 prct_surf_pehm_tdbv +
                 prct_synth +
                 densite_synth +
                 intercept_synth +
                 densite_zhp_zhp_synth +
                 densite_connect_synth +
                 #             qa +
                 #             q5 +
                 q5_qa +
                 #             prop_marais +
                 #             prop_zhp +
                 #             prop_tdbv +
                 taux_drain,
               data = stat_corr_bv_ipr_lim)

summary(mod1_lim_ipr)

plot(mod1_lim_ipr)

summary(mod1_lim_ipr)

plot(mod1_lim_ipr)


cook <- cooks.distance(mod1)

dist_cook <- as.data.frame(cook) %>% 
  rownames_to_column("sta_id") 

sf::write_sf(obj = dist_cook, dsn = "data/outputs/distance_cook_20240605.gpkg")


mod2_lim_ipr <- MASS::stepAIC(mod1_lim_ipr)

summary(mod2_lim_ipr)

mod2_lim_ner <- MASS::stepAIC(mod1_lim_ner)

summary(mod2_lim_ner)

# Sauvegarde

save(mod1_lim_ipr,
     mod2_lim_ipr,
     mod1_lim_ner,
     mod2_lim_ner,
     file = "data_processed/w_pe_bv_ipr_stat_vf_lim2.RData")

## Chargement des données LIM_BV ----

load(file = "data_processed/w_pe_bv_ipr_stat_vf_lim_bv.Rdata")

## Test de correlation ----

lim_bv_correlations_toutes_variables_synth <- 
  chart.Correlation(stat_corr_bv_ipr_lim_bv %>% 
                      dplyr::select(surface_ipr,
                                    surface_moy_pe_perm,
                                    prct_surf_pehm_tdbv,
                                    prct_synth, 
                                    densite_synth,
                                    intercept_synth,
                                    densite_zhp_zhp_synth,
                                    densite_connect_synth,
                                    #                             qa,
                                    #                             q5,
                                    q5_qa,
                                    #                             prop_marais,
                                    #                             prop_zhp,
                                    #                             prop_tdbv,
                                    #                             taux_drain,
                                    ipr, 
                                    nel, 
                                    ner),
                    histogram = TRUE,
                    pch = 19)

## modélisation de l'IPR en fonction des variables pressions plans d'eau ---

names(stat_corr_bv_ipr_lim_bv)

stat_corr_bv_ipr_lim_bv <- stat_corr_bv_ipr_lim_bv %>% 
  column_to_rownames("sta_id")

mod1_lim_bv_ipr <- lm(ipr ~
                 #             surface_ipr +
                               surface_moy_pe_perm +
                              prct_surf_pehm_tdbv +
                              prct_synth +
                 densite_synth +
                              intercept_synth +
                              densite_zhp_zhp_synth +
                              densite_connect_synth +
                 #             qa +
                 #             q5 +
                 q5_qa +
                 #             prop_marais +
                 #             prop_zhp +
                 #             prop_tdbv +
                 taux_drain,
               data = stat_corr_bv_ipr_lim_bv)

mod1_lim_bv_ner <- lm(ner ~
                    #             surface_ipr +
                    surface_moy_pe_perm +
                    prct_surf_pehm_tdbv +
                    prct_synth +
                    densite_synth +
                    intercept_synth +
                    densite_zhp_zhp_synth +
                    densite_connect_synth +
                    #             qa +
                    #             q5 +
                    q5_qa +
                    #             prop_marais +
                    #             prop_zhp +
                    #             prop_tdbv +
                    taux_drain,
                  data = stat_corr_bv_ipr_lim_bv)


summary(mod1_lim_bv_ipr)

plot(mod1_lim_bv_ipr)

summary(mod1_lim_bv_ner)

plot(mod1_lim_bv_ner)

cook <- cooks.distance(mod1)

dist_cook <- as.data.frame(cook) %>% 
  rownames_to_column("sta_id") 

sf::write_sf(obj = dist_cook, dsn = "data/outputs/distance_cook_20240605.gpkg")


mod2_lim_bv_ipr <- MASS::stepAIC(mod1_lim_bv_ipr)

summary(mod2_lim_bv)

mod2_lim_bv_ner <- MASS::stepAIC(mod1_lim_bv_ner)

summary(mod2_lim_bv_ipr)

# Sauvegarde

save(mod1_lim_bv_ipr,
     mod2_lim_bv_ipr,
     mod1_lim_bv_ner,
     mod2_lim_bv_ner,
     file = "data_processed/w_pe_bv_ipr_stat_vf_lim_bv_2.RData")



