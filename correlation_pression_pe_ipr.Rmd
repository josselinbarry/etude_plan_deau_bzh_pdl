---
title: "Etude des liens de correlation entre des indicateur de pression plans d'eau et l'indicateur de qualité des eaux IPR (Indice Poisson Rivière)"
author: "Josselin BARRY"
date: "2024-07-25"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

## Chargement des packages et des données

```{r}
library(tidyverse)
library(sf)
library(units)
library(mapview)
library(kableExtra)
library(dplyr)
library(png)
library(PerformanceAnalytics)

load(file = "data_processed/w_pe_bv_ipr_stat_vf_tot.RData")

load(file = "data_processed/w_pe_bv_ipr_stat_vf_tot2.RData")

load(file = "data_processed/w_pe_bv_ipr_stat_vf_lim.RData")

load(file = "data_processed/w_pe_bv_ipr_stat_vf_lim2.RData")

load(file = "data_processed/w_pe_bv_ipr_stat_vf_lim_bv.RData")

load(file = "data_processed/w_pe_bv_ipr_stat_vf_lim_bv_2.RData")

```

On cherche ici à tester des liens de corrélation entre des indicateurs « plans d’eau » calculés à l’échelle des bassins versants des stations IPR et les notes IPR sur ces stations. Notre choix a aussi retenu des métriques IPR permettant de cibler certains des impacts des plans d’eau.

Le principe est de modéliser la note IPR en fonction des différentes variables (a priori de pression car l’IPR est réputé insensible aux variables environnementales « naturelles ») et de voir lesquelles contribuent significativement à expliquer la variabilité des notes IPR.

Dans une telle démarche il n’est pas possible de mettre « en vrac » une multitude de variables explicatives. Celles-ci doivent être sélectionnées pour leur pertinence et ne doivent pas être exagérément corrélées entre elles. En modèle linéaire, chacune des variables doit être à peu près distribuée normalement (histogramme en cloche).

L’examen des sorties des modèles conduit à itérer pour les améliorer, en particulier en écartant des cas (des stations IPR) trop atypiques ou en simplifiant les modèles en excluant les variables explicatives non strictement nécessaires.  

## Regroupement des variables par variables de synthèse ou ACP

Une des méthodes pour éviter un trop grand nombre de variables explicative trop corrélées entre elles est de les soumettre à une Analyse en Composantes Principales (ACP). Les composantes principales (=les axes) peuvent être utilisées comme variables de synthèse. 

Les variables sont loguées pour que leurs distributions se rapprochent de la normalité, puis on étudie la possibilité de regrouper certaines variables fortement corrélées entres elles, par une variable de synthèse (ACP). On représente donc la matrice de corrélation entre les variables pour dégager des groupes de variables qui seront ensuite soumis à ces ACP séparées.

```{r}
corrplot::corrplot(bv_score_ipr_log %>% 
                     dplyr::select(-sta_id, -dit, -nte, -dio, -dii, -dti, -qa, -q5,  -prop_tdbv, -prop_zhp, -taux_drain) %>%
                     cor(method = "pearson"), 
                   order="hclust",tl.srt=45, addrect = 9)
```

**Plusieurs variables de synthèse (ACP) se dessinent :**

-	**Les indicateurs de taux de linéaire intercepté**
```{r}
acp_intercept_tot_ipr <- FactoMineR::PCA(intercept_tot_ipr, scale.unit = TRUE, ncp = 4, graph = T)
```

-	**Les indicateurs de densité surfacique**
```{r}
acp_prct_tot_ipr <- FactoMineR::PCA(prct_tot_ipr, scale.unit = TRUE, ncp = 5, graph = T)
```

-	**Les indicateurs de densité numérique**
```{r}
acp_densite_tot_ipr <- FactoMineR::PCA(densite_tot_ipr, scale.unit = TRUE, ncp = 5, graph = T)
```

-	*Les indicateurs de densité numérique des zones humides probables**
```{r}
acp_densite_zhp_zhp_tot_ipr <- FactoMineR::PCA(densite_zhp_zhp_tot_ipr, scale.unit = TRUE, ncp = 4, graph = T)
```

-	**Les indicateurs de densité numérique des plans d’eau connectés et sur cours**
```{r}
acp_connect_tot_ipr <- FactoMineR::PCA(densite_connect_tot_ipr, scale.unit = TRUE, ncp = 4, graph = T)
```

## Modélisation du lien de corrélation avec le score IPR

### A partir de l’échantillon complet et de l’ensemble des variables et co-variables

#### Graphique de corrélation

Nous effectuons ensuite un test de corrélation de ces variables et ACP entres-elles :

```{r}
afficher_carte<-function(...){
  imageList<-list(...) ;   totalWidth<-0 ;   maxHeight<-0 ;   
  for (img in imageList){    if(is.character(img)) img<-readPNG(img) ;  dimg<-dim(img) ;  totalWidth<-totalWidth+dimg[2] ;   maxHeight<-max(maxHeight,dimg[1])  }
  par(mar=c(0,0,0,0)) ;   plot(c(0,totalWidth),c(0,maxHeight),type="n",asp=1,xaxt="n",yaxt="n",xlab="x",ylab="y") ;   offset<-0 ; 
  for (img in imageList){    dimg<-dim(img) ;    rasterImage(img,offset,0,offset+dimg[2],dimg[1])
  offset<-offset+dimg[2]  }}

afficher_carte(png::readPNG('stat/images_vf/chart_correlation.png'))
```


Nous souhaitons alors modéliser (=prédire) la note IPR (et ses métriques) en fonction de variables de pressions (et de co-variables).

#### Plot(mod1) : étude de la répartition de valeurs de l’échantillon

```{r}
plot(mod1_ipr)
```

Le premier jeux de graphiques indique qu’il n’y a pas de lien entre le résidu (qui échappe au modèle, en Y) et les valeurs prédites (score IPR en x).

Le second jeux de graphiques indique que la distribution des résidus (qui échappent au modèle) est normale : les points sont alignés sur la droite, il n’y a donc pas de sur ou sous-estimation des scores en fonction des gammes de valeurs rencontrées). 

Le troisième jeux de graphiques indique qu’il n’y a pas de point qui sur-influence le modèle (il y aurait sinon 2 courbes rouges, les points à l’écart seraient en situation de sur-influencer le modèle).

Le dernier jeux de graphiques la distance de cook (x) est forte, plus le point a un bras de levier fort sur le modèle, mais si le résidu est proche de 0 (y) il garde cependant une bonne prédictivité.

**Le respect dans ce cas d’étude de ces quatre modalités de répartition des valeurs de l’échantillon indique qu’il n’y a pas de violation des hypothèses du modèle linéaire.**

#### Plot(mod2) : construction de la modélisation du score IPR : plus forte corrélation rencontrée à 0,30 :

```{r}
summary(mod2_ipr)
```

Le R² obtenu dans cette modélisation est de 0,34, indiquant que le score de 34% de l'échantillon peut être expliqué par la variable densité numérique de plans d’eau combinée aux co-variables ratio de débit et taux naturel de drainage (toutes deux inversement corrélées).

Cette modélisation indique donc que :

- Plus la densité numérique de plans d'eau est importante et plus le score IPR de la métrique NER se retrouve dégradé;

- Plus la ratio de débit est faible (période d'étiage marquée avec des débits d'étiage particulièrement faibles par rapport au module) et plus la score IPR de la métrique NER se retrouve dégradé;

- Plus la taux naturel de drainage est faible (linéaire de cours d'eau par unité de surface) et plus la score IPR de la métrique NER se retrouve dégradé;

-	La densité de plan d’eau en ZHP est faiblement et inversement corrélée (corrélation moindre), ce qui est difficile à interpréter.

###	En limitant l’analyse aux objets (bv IPR) dont la distance de cook est inférieure à 0,01 (qui s'écartent le plus de la modélisation)

On génère ainsi une nouvelle série d'analyses, en écartant les objets "atypiques" les plus éloignés de la modélisation : 

#### Graphique de corrélation

```{r}
afficher_carte<-function(...){
  imageList<-list(...) ;   totalWidth<-0 ;   maxHeight<-0 ;   
  for (img in imageList){    if(is.character(img)) img<-readPNG(img) ;  dimg<-dim(img) ;  totalWidth<-totalWidth+dimg[2] ;   maxHeight<-max(maxHeight,dimg[1])  }
  par(mar=c(0,0,0,0)) ;   plot(c(0,totalWidth),c(0,maxHeight),type="n",asp=1,xaxt="n",yaxt="n",xlab="x",ylab="y") ;   offset<-0 ; 
  for (img in imageList){    dimg<-dim(img) ;    rasterImage(img,offset,0,offset+dimg[2],dimg[1])
  offset<-offset+dimg[2]  }}

afficher_carte(png::readPNG('stat/images_vf/chart_corr_lim.png'))
```
```{r}
summary(mod1_lim_ipr)
```

#### Plot(mod1) : 

```{r}
plot(mod1_lim_ipr)
```

#### Plot(mod2) : 

```{r}
summary(mod2_lim_ipr)
```
Cette seconde modélisation propose les même variables et co-variables explicatives du score IPR que la précédente avec toutefois une amélioration de la significativité avec un R² de O,38.

### En limitant l’analyse aux objets (bv IPR) dont la distance de cook est inférieure à 0,01 et aux 20% des BV les plus petits 

On cherche ici à s’affranchir des pressions cumulées tierces (moins prégnantes sur de plus petites territoires). 
On génère ainsi une nouvelle série d'analyses : 

#### Graphique de corrélation

```{r}
afficher_carte<-function(...){
  imageList<-list(...) ;   totalWidth<-0 ;   maxHeight<-0 ;   
  for (img in imageList){    if(is.character(img)) img<-readPNG(img) ;  dimg<-dim(img) ;  totalWidth<-totalWidth+dimg[2] ;   maxHeight<-max(maxHeight,dimg[1])  }
  par(mar=c(0,0,0,0)) ;   plot(c(0,totalWidth),c(0,maxHeight),type="n",asp=1,xaxt="n",yaxt="n",xlab="x",ylab="y") ;   offset<-0 ; 
  for (img in imageList){    dimg<-dim(img) ;    rasterImage(img,offset,0,offset+dimg[2],dimg[1])
  offset<-offset+dimg[2]  }}

afficher_carte(png::readPNG('stat/images_vf/chart_corr_lim_bv.png'))
```

```{r}
summary(mod1_lim_bv_ipr)
```

#### Plot(mod1) : 

```{r}
plot(mod1_lim_bv_ipr)
```
#### Plot(mod2) : 

```{r}
summary(mod2_lim_bv_ipr)
```
Cette dernière modélisation ressort moins de co-variables (la ratio de débits disparait de la modélisation). La pression densité numérique de plans d’eau reste l'ACP la mieux corrélée, les co-variables de manière moins significatives. 
Le R² obtenu dans cette modélisation est de 0,41, indiquant que le score de 41% de l'échantillon peut être expliqué par la variable densité numérique de plans d’eau et ses co-variables.

## Modélisation du lien de corrélation avec le score de la métrique IPR NER

Le Score de la métrique "Nombre d'Espèces Rhéophiles (NER)" traduit la qualité du bassin versant au regard de ses espèces réophiles. Il nous semble un bon reflet de l'impact des plans d'eau par lentification des milieux aquatiques. Aussi l'avons nous retenu pour analyse.

### Ensemble de l'échantillon

#### Plot(mod1) : 

```{r}
plot(mod1_ner)
```
#### Plot(mod2) : 

```{r}
summary(mod2_ner)
```

### En limitant l’analyse aux objets (bv IPR) dont la distance de cook est inférieure à 0,01 

#### Plot(mod1) : 

```{r}
plot(mod1_lim_ner)
```
#### Plot(mod2) : 

```{r}
summary(mod2_lim_ner)
```

### En limitant l’analyse aux objets (bv IPR) dont la distance de cook est inférieure à 0,01 et aux 20% des BV les plus petits 

#### Plot(mod1) : 

```{r}
plot(mod1_lim_bv_ner)
```
#### Plot(mod2) : 

```{r}
summary(mod2_lim_bv_ner)
```

##	Elements d'analyse

-	C’est l’ACP de pression plan d’eau « densité numérique » qui rencontre la plus forte corrélation avec les scores IPR, quelques qoient les paramétres de modélisation retenus dans cette analyse.
Il apparait ainsi que l’effet "cumul des plans d’eau" semble donc plus impactant que la proportion de surface en plan d’eau des territoires sur le score IPR

-	Le rapport du qmna5 sur le module qui est une co-variable (profil de crise hydrique en situation d’étiage), est assez fortement et inversement corrélée au score IPR (sauf dans le cas des BV les plus petits où elle est positivement corrélée avec une significativité moindre).

-	Le taux naturel de drainage est également une co-variable inversement corrélée au score IPR mais plus faiblement.

L’IPR intègre dans sa note la variabilité environnementale afin de caractériser les pressions du milieu sans qu’il n’y ait de lien entre la note IPR et ces variables d’environnement (surface BV, pente, …). De très nombreuses sources de variabilité peuvent toutefois venir expliquer le score IPR :

-	IPR développé à l’échelle régionale et régionalisé très grossièrement => pas nécessairement 100% adapté à notre échelle d’étude

```{r}
afficher_carte<-function(...){
  imageList<-list(...) ;   totalWidth<-0 ;   maxHeight<-0 ;   
  for (img in imageList){    if(is.character(img)) img<-readPNG(img) ;  dimg<-dim(img) ;  totalWidth<-totalWidth+dimg[2] ;   maxHeight<-max(maxHeight,dimg[1])  }
  par(mar=c(0,0,0,0)) ;   plot(c(0,totalWidth),c(0,maxHeight),type="n",asp=1,xaxt="n",yaxt="n",xlab="x",ylab="y") ;   offset<-0 ; 
  for (img in imageList){    dimg<-dim(img) ;    rasterImage(img,offset,0,offset+dimg[2],dimg[1])
  offset<-offset+dimg[2]  }}

afficher_carte(png::readPNG('data/cartes/ipr_region.png'))
```

-	Variabilité interannuelle
-	Diversité et multiplicité des pressions
-	…

**Le résultat obtenu à la lecture de cette variabilité est donc intéressant car il démontre un lien de corrélation significatif entre la pression exercée par les plans d'eau sur un territoire et le score de qualité piscicole obtenu par ses cours d'eau.**

## Pistes à creuser :

-	Affiner les variables en entré (ACP ? ne conserver que la plus corrélée de chaque groupe ? … ?).

-	Ajouter des co-variables liées aux spécificités régionales (HER2 ?)

-	Incorporer les prélèvements

- Validation des modèles : cartographier les résidus et faire graphique valeur prédite vs. valeur observée.






